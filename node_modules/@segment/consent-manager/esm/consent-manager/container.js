import _getIterator from 'babel-runtime/core-js/get-iterator';
import _defineProperty from 'babel-runtime/helpers/defineProperty';
import _Object$getPrototypeOf from 'babel-runtime/core-js/object/get-prototype-of';
import _classCallCheck from 'babel-runtime/helpers/classCallCheck';
import _createClass from 'babel-runtime/helpers/createClass';
import _possibleConstructorReturn from 'babel-runtime/helpers/possibleConstructorReturn';
import _inherits from 'babel-runtime/helpers/inherits';
import EventEmitter from 'events';
import React, { PureComponent } from 'react';
import PropTypes from 'prop-types';
import Banner from './banner';
import PreferenceDialog from './preference-dialog';
import CancelDialog from './cancel-dialog';
import { ADVERTISING_CATEGORIES, FUNCTIONAL_CATEGORIES } from './categories';

var emitter = new EventEmitter();

export function openDialog() {
  emitter.emit('openDialog');
}

var Container = function (_PureComponent) {
  _inherits(Container, _PureComponent);

  function Container() {
    var _ref;

    var _temp, _this, _ret;

    _classCallCheck(this, Container);

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    return _ret = (_temp = (_this = _possibleConstructorReturn(this, (_ref = Container.__proto__ || _Object$getPrototypeOf(Container)).call.apply(_ref, [this].concat(args))), _this), _this.state = {
      isDialogOpen: false,
      isCancelling: false
    }, _this.openDialog = function () {
      _this.setState({
        isDialogOpen: true
      });
    }, _this.closeDialog = function () {
      _this.setState({
        isDialogOpen: false
      });
    }, _this.handleBannerRef = function (node) {
      _this.banner = node;
    }, _this.handlePreferenceDialogRef = function (node) {
      _this.preferenceDialog = node;
    }, _this.handleCancelDialogRef = function (node) {
      _this.cancelDialog = node;
    }, _this.handleBannerAccept = function () {
      var saveConsent = _this.props.saveConsent;


      saveConsent();
    }, _this.handleBodyClick = function (e) {
      var _this$props = _this.props,
          newDestinations = _this$props.newDestinations,
          saveConsent = _this$props.saveConsent,
          isConsentRequired = _this$props.isConsentRequired,
          implyConsentOnInteraction = _this$props.implyConsentOnInteraction;

      // Do nothing if no new implicit consent needs to be saved

      if (!isConsentRequired || !implyConsentOnInteraction || newDestinations.length === 0) {
        return;
      }

      // Ignore propogated clicks from inside the consent manager
      if (_this.banner && _this.banner.contains(e.target) || _this.preferenceDialog && _this.preferenceDialog.contains(e.target) || _this.cancelDialog && _this.cancelDialog.contains(e.target)) {
        return;
      }

      saveConsent(undefined, false);
    }, _this.handleCategoryChange = function (category, value) {
      var setPreferences = _this.props.setPreferences;


      setPreferences(_defineProperty({}, category, value));
    }, _this.handleSave = function () {
      var saveConsent = _this.props.saveConsent;


      _this.setState({
        isDialogOpen: false
      });
      saveConsent();
    }, _this.handleCancel = function () {
      var _this$props2 = _this.props,
          resetPreferences = _this$props2.resetPreferences,
          newDestinations = _this$props2.newDestinations;


      _this.setState({
        isDialogOpen: false
      });

      // Only show the cancel confirmation if there's unconsented destinations
      if (newDestinations.length > 0) {
        _this.setState({
          isCancelling: true
        });
      } else {
        resetPreferences();
      }
    }, _this.handleCancelBack = function () {
      _this.setState({
        isDialogOpen: true,
        isCancelling: false
      });
    }, _this.handleCancelConfirm = function () {
      var resetPreferences = _this.props.resetPreferences;


      _this.setState({
        isCancelling: false
      });
      resetPreferences();
    }, _temp), _possibleConstructorReturn(_this, _ret);
  }

  _createClass(Container, [{
    key: 'render',
    value: function render() {
      var _props = this.props,
          destinations = _props.destinations,
          newDestinations = _props.newDestinations,
          preferences = _props.preferences,
          isConsentRequired = _props.isConsentRequired,
          bannerContent = _props.bannerContent,
          bannerSubContent = _props.bannerSubContent,
          bannerTextColor = _props.bannerTextColor,
          bannerBackgroundColor = _props.bannerBackgroundColor,
          preferencesDialogTitle = _props.preferencesDialogTitle,
          preferencesDialogContent = _props.preferencesDialogContent,
          cancelDialogTitle = _props.cancelDialogTitle,
          cancelDialogContent = _props.cancelDialogContent;
      var _state = this.state,
          isDialogOpen = _state.isDialogOpen,
          isCancelling = _state.isCancelling;

      var marketingDestinations = [];
      var advertisingDestinations = [];
      var functionalDestinations = [];

      var _loop = function _loop(destination) {
        if (ADVERTISING_CATEGORIES.find(function (c) {
          return c === destination.category;
        })) {
          advertisingDestinations.push(destination);
        } else if (FUNCTIONAL_CATEGORIES.find(function (c) {
          return c === destination.category;
        })) {
          functionalDestinations.push(destination);
        } else {
          // Fallback to marketing
          marketingDestinations.push(destination);
        }
      };

      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(destinations), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var destination = _step.value;

          _loop(destination);
        }

        // TODO: add state for banner so it doesn't disappear on implicit consent (which is annoying UX)
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      return React.createElement(
        'div',
        null,
        isConsentRequired && newDestinations.length > 0 && React.createElement(Banner, {
          innerRef: this.handleBannerRef,
          onAccept: this.handleBannerAccept,
          onChangePreferences: this.openDialog,
          content: bannerContent,
          subContent: bannerSubContent,
          textColor: bannerTextColor,
          backgroundColor: bannerBackgroundColor
        }),
        isDialogOpen && React.createElement(PreferenceDialog, {
          innerRef: this.handlePreferenceDialogRef,
          onCancel: this.handleCancel,
          onSave: this.handleSave,
          onChange: this.handleCategoryChange,
          marketingDestinations: marketingDestinations,
          advertisingDestinations: advertisingDestinations,
          functionalDestinations: functionalDestinations,
          marketingAndAnalytics: preferences.marketingAndAnalytics,
          advertising: preferences.advertising,
          functional: preferences.functional,
          title: preferencesDialogTitle,
          content: preferencesDialogContent
        }),
        isCancelling && React.createElement(CancelDialog, {
          innerRef: this.handleCancelDialogRef,
          onBack: this.handleCancelBack,
          onConfirm: this.handleCancelConfirm,
          title: cancelDialogTitle,
          content: cancelDialogContent
        })
      );
    }
  }, {
    key: 'componentDidMount',
    value: function componentDidMount() {
      var _props2 = this.props,
          isConsentRequired = _props2.isConsentRequired,
          implyConsentOnInteraction = _props2.implyConsentOnInteraction;


      emitter.on('openDialog', this.openDialog);

      if (isConsentRequired && implyConsentOnInteraction) {
        document.body.addEventListener('click', this.handleBodyClick, false);
      }
    }
  }, {
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      emitter.removeListener('openDialog', this.openDialog);
      document.body.removeEventListener('click', this.handleBodyClick, false);
    }
  }]);

  return Container;
}(PureComponent);

Container.displayName = 'Container';
Container.propTypes = {
  setPreferences: PropTypes.func.isRequired,
  resetPreferences: PropTypes.func.isRequired,
  saveConsent: PropTypes.func.isRequired,
  destinations: PropTypes.arrayOf(PropTypes.object).isRequired,
  newDestinations: PropTypes.arrayOf(PropTypes.object).isRequired,
  preferences: PropTypes.object.isRequired,
  isConsentRequired: PropTypes.bool.isRequired,
  implyConsentOnInteraction: PropTypes.bool.isRequired,
  bannerContent: PropTypes.node.isRequired,
  bannerSubContent: PropTypes.string.isRequired,
  bannerTextColor: PropTypes.string.isRequired,
  bannerBackgroundColor: PropTypes.string.isRequired,
  preferencesDialogTitle: PropTypes.node.isRequired,
  preferencesDialogContent: PropTypes.node.isRequired,
  cancelDialogTitle: PropTypes.node.isRequired,
  cancelDialogContent: PropTypes.node.isRequired
};
export default Container;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25zZW50LW1hbmFnZXIvY29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIkV2ZW50RW1pdHRlciIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsIlByb3BUeXBlcyIsIkJhbm5lciIsIlByZWZlcmVuY2VEaWFsb2ciLCJDYW5jZWxEaWFsb2ciLCJBRFZFUlRJU0lOR19DQVRFR09SSUVTIiwiRlVOQ1RJT05BTF9DQVRFR09SSUVTIiwiZW1pdHRlciIsIm9wZW5EaWFsb2ciLCJlbWl0IiwiQ29udGFpbmVyIiwic3RhdGUiLCJpc0RpYWxvZ09wZW4iLCJpc0NhbmNlbGxpbmciLCJzZXRTdGF0ZSIsImNsb3NlRGlhbG9nIiwiaGFuZGxlQmFubmVyUmVmIiwiYmFubmVyIiwibm9kZSIsImhhbmRsZVByZWZlcmVuY2VEaWFsb2dSZWYiLCJwcmVmZXJlbmNlRGlhbG9nIiwiaGFuZGxlQ2FuY2VsRGlhbG9nUmVmIiwiY2FuY2VsRGlhbG9nIiwiaGFuZGxlQmFubmVyQWNjZXB0Iiwic2F2ZUNvbnNlbnQiLCJwcm9wcyIsImhhbmRsZUJvZHlDbGljayIsIm5ld0Rlc3RpbmF0aW9ucyIsImlzQ29uc2VudFJlcXVpcmVkIiwiaW1wbHlDb25zZW50T25JbnRlcmFjdGlvbiIsImxlbmd0aCIsImNvbnRhaW5zIiwiZSIsInRhcmdldCIsInVuZGVmaW5lZCIsImhhbmRsZUNhdGVnb3J5Q2hhbmdlIiwiY2F0ZWdvcnkiLCJ2YWx1ZSIsInNldFByZWZlcmVuY2VzIiwiaGFuZGxlU2F2ZSIsImhhbmRsZUNhbmNlbCIsInJlc2V0UHJlZmVyZW5jZXMiLCJoYW5kbGVDYW5jZWxCYWNrIiwiaGFuZGxlQ2FuY2VsQ29uZmlybSIsImRlc3RpbmF0aW9ucyIsInByZWZlcmVuY2VzIiwiYmFubmVyQ29udGVudCIsImJhbm5lclN1YkNvbnRlbnQiLCJiYW5uZXJUZXh0Q29sb3IiLCJiYW5uZXJCYWNrZ3JvdW5kQ29sb3IiLCJwcmVmZXJlbmNlc0RpYWxvZ1RpdGxlIiwicHJlZmVyZW5jZXNEaWFsb2dDb250ZW50IiwiY2FuY2VsRGlhbG9nVGl0bGUiLCJjYW5jZWxEaWFsb2dDb250ZW50IiwibWFya2V0aW5nRGVzdGluYXRpb25zIiwiYWR2ZXJ0aXNpbmdEZXN0aW5hdGlvbnMiLCJmdW5jdGlvbmFsRGVzdGluYXRpb25zIiwiZGVzdGluYXRpb24iLCJmaW5kIiwiYyIsInB1c2giLCJtYXJrZXRpbmdBbmRBbmFseXRpY3MiLCJhZHZlcnRpc2luZyIsImZ1bmN0aW9uYWwiLCJvbiIsImRvY3VtZW50IiwiYm9keSIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVMaXN0ZW5lciIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsImZ1bmMiLCJpc1JlcXVpcmVkIiwiYXJyYXlPZiIsIm9iamVjdCIsImJvb2wiLCJzdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxPQUFPQSxZQUFQLE1BQXlCLFFBQXpCO0FBQ0EsT0FBT0MsS0FBUCxJQUFlQyxhQUFmLFFBQW1DLE9BQW5DO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQixZQUF0QjtBQUNBLE9BQU9DLE1BQVAsTUFBbUIsVUFBbkI7QUFDQSxPQUFPQyxnQkFBUCxNQUE2QixxQkFBN0I7QUFDQSxPQUFPQyxZQUFQLE1BQXlCLGlCQUF6QjtBQUNBLFNBQVFDLHNCQUFSLEVBQWdDQyxxQkFBaEMsUUFBNEQsY0FBNUQ7O0FBRUEsSUFBTUMsVUFBVSxJQUFJVCxZQUFKLEVBQWhCOztBQUVBLE9BQU8sU0FBU1UsVUFBVCxHQUFzQjtBQUMzQkQsVUFBUUUsSUFBUixDQUFhLFlBQWI7QUFDRDs7SUFFb0JDLFM7Ozs7Ozs7Ozs7Ozs7OzZMQXNCbkJDLEssR0FBUTtBQUNOQyxvQkFBYyxLQURSO0FBRU5DLG9CQUFjO0FBRlIsSyxRQStGUkwsVSxHQUFhLFlBQU07QUFDakIsWUFBS00sUUFBTCxDQUFjO0FBQ1pGLHNCQUFjO0FBREYsT0FBZDtBQUdELEssUUFFREcsVyxHQUFjLFlBQU07QUFDbEIsWUFBS0QsUUFB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bnRlbnQiOlsiaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnXG5pbXBvcnQgUmVhY3QsIHtQdXJlQ29tcG9uZW50fSBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCBCYW5uZXIgZnJvbSAnLi9iYW5uZXInXG5pbXBvcnQgUHJlZmVyZW5jZURpYWxvZyBmcm9tICcuL3ByZWZlcmVuY2UtZGlhbG9nJ1xuaW1wb3J0IENhbmNlbERpYWxvZyBmcm9tICcuL2NhbmNlbC1kaWFsb2cnXG5pbXBvcnQge0FEVkVSVElTSU5HX0NBVEVHT1JJRVMsIEZVTkNUSU9OQUxfQ0FURUdPUklFU30gZnJvbSAnLi9jYXRlZ29yaWVzJ1xuXG5jb25zdCBlbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpXG5cbmV4cG9ydCBmdW5jdGlvbiBvcGVuRGlhbG9nKCkge1xuICBlbWl0dGVyLmVtaXQoJ29wZW5EaWFsb2cnKVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb250YWluZXIgZXh0ZW5kcyBQdXJlQ29tcG9uZW50IHtcbiAgc3RhdGljIGRpc3BsYXlOYW1lID0gJ0NvbnRhaW5lcidcblxuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIHNldFByZWZlcmVuY2VzOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICAgIHJlc2V0UHJlZmVyZW5jZXM6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gICAgc2F2ZUNvbnNlbnQ6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gICAgZGVzdGluYXRpb25zOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMub2JqZWN0KS5pc1JlcXVpcmVkLFxuICAgIG5ld0Rlc3RpbmF0aW9uczogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLm9iamVjdCkuaXNSZXF1aXJlZCxcbiAgICBwcmVmZXJlbmNlczogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIGlzQ29uc2VudFJlcXVpcmVkOiBQcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLFxuICAgIGltcGx5Q29uc2VudE9uSW50ZXJhY3Rpb246IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsXG4gICAgYmFubmVyQ29udGVudDogUHJvcFR5cGVzLm5vZGUuaXNSZXF1aXJlZCxcbiAgICBiYW5uZXJTdWJDb250ZW50OiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgYmFubmVyVGV4dENvbG9yOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgYmFubmVyQmFja2dyb3VuZENvbG9yOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgcHJlZmVyZW5jZXNEaWFsb2dUaXRsZTogUHJvcFR5cGVzLm5vZGUuaXNSZXF1aXJlZCxcbiAgICBwcmVmZXJlbmNlc0RpYWxvZ0NvbnRlbnQ6IFByb3BUeXBlcy5ub2RlLmlzUmVxdWlyZWQsXG4gICAgY2FuY2VsRGlhbG9nVGl0bGU6IFByb3BUeXBlcy5ub2RlLmlzUmVxdWlyZWQsXG4gICAgY2FuY2VsRGlhbG9nQ29udGVudDogUHJvcFR5cGVzLm5vZGUuaXNSZXF1aXJlZFxuICB9XG5cbiAgc3RhdGUgPSB7XG4gICAgaXNEaWFsb2dPcGVuOiBmYWxzZSxcbiAgICBpc0NhbmNlbGxpbmc6IGZhbHNlXG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgZGVzdGluYXRpb25zLFxuICAgICAgbmV3RGVzdGluYXRpb25zLFxuICAgICAgcHJlZmVyZW5jZXMsXG4gICAgICBpc0NvbnNlbnRSZXF1aXJlZCxcbiAgICAgIGJhbm5lckNvbnRlbnQsXG4gICAgICBiYW5uZXJTdWJDb250ZW50LFxuICAgICAgYmFubmVyVGV4dENvbG9yLFxuICAgICAgYmFubmVyQmFja2dyb3VuZENvbG9yLFxuICAgICAgcHJlZmVyZW5jZXNEaWFsb2dUaXRsZSxcbiAgICAgIHByZWZlcmVuY2VzRGlhbG9nQ29udGVudCxcbiAgICAgIGNhbmNlbERpYWxvZ1RpdGxlLFxuICAgICAgY2FuY2VsRGlhbG9nQ29udGVudFxuICAgIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3Qge2lzRGlhbG9nT3BlbiwgaXNDYW5jZWxsaW5nfSA9IHRoaXMuc3RhdGVcbiAgICBjb25zdCBtYXJrZXRpbmdEZXN0aW5hdGlvbnMgPSBbXVxuICAgIGNvbnN0IGFkdmVydGlzaW5nRGVzdGluYXRpb25zID0gW11cbiAgICBjb25zdCBmdW5jdGlvbmFsRGVzdGluYXRpb25zID0gW11cblxuICAgIGZvciAoY29uc3QgZGVzdGluYXRpb24gb2YgZGVzdGluYXRpb25zKSB7XG4gICAgICBpZiAoQURWRVJUSVNJTkdfQ0FURUdPUklFUy5maW5kKGMgPT4gYyA9PT0gZGVzdGluYXRpb24uY2F0ZWdvcnkpKSB7XG4gICAgICAgIGFkdmVydGlzaW5nRGVzdGluYXRpb25zLnB1c2goZGVzdGluYXRpb24pXG4gICAgICB9IGVsc2UgaWYgKEZVTkNUSU9OQUxfQ0FURUdPUklFUy5maW5kKGMgPT4gYyA9PT0gZGVzdGluYXRpb24uY2F0ZWdvcnkpKSB7XG4gICAgICAgIGZ1bmN0aW9uYWxEZXN0aW5hdGlvbnMucHVzaChkZXN0aW5hdGlvbilcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIEZhbGxiYWNrIHRvIG1hcmtldGluZ1xuICAgICAgICBtYXJrZXRpbmdEZXN0aW5hdGlvbnMucHVzaChkZXN0aW5hdGlvbilcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBUT0RPOiBhZGQgc3RhdGUgZm9yIGJhbm5lciBzbyBpdCBkb2Vzbid0IGRpc2FwcGVhciBvbiBpbXBsaWNpdCBjb25zZW50ICh3aGljaCBpcyBhbm5veWluZyBVWClcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdj5cbiAgICAgICAge2lzQ29uc2VudFJlcXVpcmVkICYmXG4gICAgICAgICAgbmV3RGVzdGluYXRpb25zLmxlbmd0aCA+IDAgJiYgKFxuICAgICAgICAgICAgPEJhbm5lclxuICAgICAgICAgICAgICBpbm5lclJlZj17dGhpcy5oYW5kbGVCYW5uZXJSZWZ9XG4gICAgICAgICAgICAgIG9uQWNjZXB0PXt0aGlzLmhhbmRsZUJhbm5lckFjY2VwdH1cbiAgICAgICAgICAgICAgb25DaGFuZ2VQcmVmZXJlbmNlcz17dGhpcy5vcGVuRGlhbG9nfVxuICAgICAgICAgICAgICBjb250ZW50PXtiYW5uZXJDb250ZW50fVxuICAgICAgICAgICAgICBzdWJDb250ZW50PXtiYW5uZXJTdWJDb250ZW50fVxuICAgICAgICAgICAgICB0ZXh0Q29sb3I9e2Jhbm5lclRleHRDb2xvcn1cbiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yPXtiYW5uZXJCYWNrZ3JvdW5kQ29sb3J9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICl9XG4gICAgICAgIHtpc0RpYWxvZ09wZW4gJiYgKFxuICAgICAgICAgIDxQcmVmZXJlbmNlRGlhbG9nXG4gICAgICAgICAgICBpbm5lclJlZj17dGhpcy5oYW5kbGVQcmVmZXJlbmNlRGlhbG9nUmVmfVxuICAgICAgICAgICAgb25DYW5jZWw9e3RoaXMuaGFuZGxlQ2FuY2VsfVxuICAgICAgICAgICAgb25TYXZlPXt0aGlzLmhhbmRsZVNhdmV9XG4gICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5oYW5kbGVDYXRlZ29yeUNoYW5nZX1cbiAgICAgICAgICAgIG1hcmtldGluZ0Rlc3RpbmF0aW9ucz17bWFya2V0aW5nRGVzdGluYXRpb25zfVxuICAgICAgICAgICAgYWR2ZXJ0aXNpbmdEZXN0aW5hdGlvbnM9e2FkdmVydGlzaW5nRGVzdGluYXRpb25zfVxuICAgICAgICAgICAgZnVuY3Rpb25hbERlc3RpbmF0aW9ucz17ZnVuY3Rpb25hbERlc3RpbmF0aW9uc31cbiAgICAgICAgICAgIG1hcmtldGluZ0FuZEFuYWx5dGljcz17cHJlZmVyZW5jZXMubWFya2V0aW5nQW5kQW5hbHl0aWNzfVxuICAgICAgICAgICAgYWR2ZXJ0aXNpbmc9e3ByZWZlcmVuY2VzLmFkdmVydGlzaW5nfVxuICAgICAgICAgICAgZnVuY3Rpb25hbD17cHJlZmVyZW5jZXMuZnVuY3Rpb25hbH1cbiAgICAgICAgICAgIHRpdGxlPXtwcmVmZXJlbmNlc0RpYWxvZ1RpdGxlfVxuICAgICAgICAgICAgY29udGVudD17cHJlZmVyZW5jZXNEaWFsb2dDb250ZW50fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHtpc0NhbmNlbGxpbmcgJiYgKFxuICAgICAgICAgIDxDYW5jZWxEaWFsb2dcbiAgICAgICAgICAgIGlubmVyUmVmPXt0aGlzLmhhbmRsZUNhbmNlbERpYWxvZ1JlZn1cbiAgICAgICAgICAgIG9uQmFjaz17dGhpcy5oYW5kbGVDYW5jZWxCYWNrfVxuICAgICAgICAgICAgb25Db25maXJtPXt0aGlzLmhhbmRsZUNhbmNlbENvbmZpcm19XG4gICAgICAgICAgICB0aXRsZT17Y2FuY2VsRGlhbG9nVGl0bGV9XG4gICAgICAgICAgICBjb250ZW50PXtjYW5jZWxEaWFsb2dDb250ZW50fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cbiAgICApXG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICBjb25zdCB7aXNDb25zZW50UmVxdWlyZWQsIGltcGx5Q29uc2VudE9uSW50ZXJhY3Rpb259ID0gdGhpcy5wcm9wc1xuXG4gICAgZW1pdHRlci5vbignb3BlbkRpYWxvZycsIHRoaXMub3BlbkRpYWxvZylcblxuICAgIGlmIChpc0NvbnNlbnRSZXF1aXJlZCAmJiBpbXBseUNvbnNlbnRPbkludGVyYWN0aW9uKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5oYW5kbGVCb2R5Q2xpY2ssIGZhbHNlKVxuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoJ29wZW5EaWFsb2cnLCB0aGlzLm9wZW5EaWFsb2cpXG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuaGFuZGxlQm9keUNsaWNrLCBmYWxzZSlcbiAgfVxuXG4gIG9wZW5EaWFsb2cgPSAoKSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBpc0RpYWxvZ09wZW46IHRydWVcbiAgICB9KVxuICB9XG5cbiAgY2xvc2VEaWFsb2cgPSAoKSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBpc0RpYWxvZ09wZW46IGZhbHNlXG4gICAgfSlcbiAgfVxuXG4gIGhhbmRsZUJhbm5lclJlZiA9IG5vZGUgPT4ge1xuICAgIHRoaXMuYmFubmVyID0gbm9kZVxuICB9XG5cbiAgaGFuZGxlUHJlZmVyZW5jZURpYWxvZ1JlZiA9IG5vZGUgPT4ge1xuICAgIHRoaXMucHJlZmVyZW5jZURpYWxvZyA9IG5vZGVcbiAgfVxuXG4gIGhhbmRsZUNhbmNlbERpYWxvZ1JlZiA9IG5vZGUgPT4ge1xuICAgIHRoaXMuY2FuY2VsRGlhbG9nID0gbm9kZVxuICB9XG5cbiAgaGFuZGxlQmFubmVyQWNjZXB0ID0gKCkgPT4ge1xuICAgIGNvbnN0IHtzYXZlQ29uc2VudH0gPSB0aGlzLnByb3BzXG5cbiAgICBzYXZlQ29uc2VudCgpXG4gIH1cblxuICBoYW5kbGVCb2R5Q2xpY2sgPSBlID0+IHtcbiAgICBjb25zdCB7XG4gICAgICBuZXdEZXN0aW5hdGlvbnMsXG4gICAgICBzYXZlQ29uc2VudCxcbiAgICAgIGlzQ29uc2VudFJlcXVpcmVkLFxuICAgICAgaW1wbHlDb25zZW50T25JbnRlcmFjdGlvblxuICAgIH0gPSB0aGlzLnByb3BzXG5cbiAgICAvLyBEbyBub3RoaW5nIGlmIG5vIG5ldyBpbXBsaWNpdCBjb25zZW50IG5lZWRzIHRvIGJlIHNhdmVkXG4gICAgaWYgKFxuICAgICAgIWlzQ29uc2VudFJlcXVpcmVkIHx8XG4gICAgICAhaW1wbHlDb25zZW50T25JbnRlcmFjdGlvbiB8fFxuICAgICAgbmV3RGVzdGluYXRpb25zLmxlbmd0aCA9PT0gMFxuICAgICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgLy8gSWdub3JlIHByb3BvZ2F0ZWQgY2xpY2tzIGZyb20gaW5zaWRlIHRoZSBjb25zZW50IG1hbmFnZXJcbiAgICBpZiAoXG4gICAgICAodGhpcy5iYW5uZXIgJiYgdGhpcy5iYW5uZXIuY29udGFpbnMoZS50YXJnZXQpKSB8fFxuICAgICAgKHRoaXMucHJlZmVyZW5jZURpYWxvZyAmJiB0aGlzLnByZWZlcmVuY2VEaWFsb2cuY29udGFpbnMoZS50YXJnZXQpKSB8fFxuICAgICAgKHRoaXMuY2FuY2VsRGlhbG9nICYmIHRoaXMuY2FuY2VsRGlhbG9nLmNvbnRhaW5zKGUudGFyZ2V0KSlcbiAgICApIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHNhdmVDb25zZW50KHVuZGVmaW5lZCwgZmFsc2UpXG4gIH1cblxuICBoYW5kbGVDYXRlZ29yeUNoYW5nZSA9IChjYXRlZ29yeSwgdmFsdWUpID0+IHtcbiAgICBjb25zdCB7c2V0UHJlZmVyZW5jZXN9ID0gdGhpcy5wcm9wc1xuXG4gICAgc2V0UHJlZmVyZW5jZXMoe1xuICAgICAgW2NhdGVnb3J5XTogdmFsdWVcbiAgICB9KVxuICB9XG5cbiAgaGFuZGxlU2F2ZSA9ICgpID0+IHtcbiAgICBjb25zdCB7c2F2ZUNvbnNlbnR9ID0gdGhpcy5wcm9wc1xuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBpc0RpYWxvZ09wZW46IGZhbHNlXG4gICAgfSlcbiAgICBzYXZlQ29uc2VudCgpXG4gIH1cblxuICBoYW5kbGVDYW5jZWwgPSAoKSA9PiB7XG4gICAgY29uc3Qge3Jlc2V0UHJlZmVyZW5jZXMsIG5ld0Rlc3RpbmF0aW9uc30gPSB0aGlzLnByb3BzXG5cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGlzRGlhbG9nT3BlbjogZmFsc2VcbiAgICB9KVxuXG4gICAgLy8gT25seSBzaG93IHRoZSBjYW5jZWwgY29uZmlybWF0aW9uIGlmIHRoZXJlJ3MgdW5jb25zZW50ZWQgZGVzdGluYXRpb25zXG4gICAgaWYgKG5ld0Rlc3RpbmF0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgaXNDYW5jZWxsaW5nOiB0cnVlXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXNldFByZWZlcmVuY2VzKClcbiAgICB9XG4gIH1cblxuICBoYW5kbGVDYW5jZWxCYWNrID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNEaWFsb2dPcGVuOiB0cnVlLFxuICAgICAgaXNDYW5jZWxsaW5nOiBmYWxzZVxuICAgIH0pXG4gIH1cblxuICBoYW5kbGVDYW5jZWxDb25maXJtID0gKCkgPT4ge1xuICAgIGNvbnN0IHtyZXNldFByZWZlcmVuY2VzfSA9IHRoaXMucHJvcHNcblxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNDYW5jZWxsaW5nOiBmYWxzZVxuICAgIH0pXG4gICAgcmVzZXRQcmVmZXJlbmNlcygpXG4gIH1cbn1cbiJdfQ==