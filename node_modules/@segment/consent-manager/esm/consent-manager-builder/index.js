import _extends from 'babel-runtime/helpers/extends';
import _regeneratorRuntime from 'babel-runtime/regenerator';
import _toConsumableArray from 'babel-runtime/helpers/toConsumableArray';
import _Promise from 'babel-runtime/core-js/promise';
import _slicedToArray from 'babel-runtime/helpers/slicedToArray';
import _asyncToGenerator from 'babel-runtime/helpers/asyncToGenerator';
import _Object$getPrototypeOf from 'babel-runtime/core-js/object/get-prototype-of';
import _classCallCheck from 'babel-runtime/helpers/classCallCheck';
import _createClass from 'babel-runtime/helpers/createClass';
import _possibleConstructorReturn from 'babel-runtime/helpers/possibleConstructorReturn';
import _inherits from 'babel-runtime/helpers/inherits';
import _getIterator from 'babel-runtime/core-js/get-iterator';
import { Component } from 'react';
import PropTypes from 'prop-types';
import { loadPreferences, savePreferences } from './preferences';
import fetchDestinations from './fetch-destinations';
import conditionallyLoadAnalytics from './analytics';

function getNewDestinations(destinations, preferences) {
  var newDestinations = [];

  // If there are no preferences then all destinations are new
  if (!preferences) {
    return destinations;
  }

  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(destinations), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var destination = _step.value;

      if (preferences[destination.id] === undefined) {
        newDestinations.push(destination);
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return newDestinations;
}

var ConsentManagerBuilder = function (_Component) {
  _inherits(ConsentManagerBuilder, _Component);

  function ConsentManagerBuilder() {
    var _ref,
        _this2 = this;

    var _temp, _this, _ret;

    _classCallCheck(this, ConsentManagerBuilder);

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    return _ret = (_temp = (_this = _possibleConstructorReturn(this, (_ref = ConsentManagerBuilder.__proto__ || _Object$getPrototypeOf(ConsentManagerBuilder)).call.apply(_ref, [this].concat(args))), _this), _this.state = {
      isLoading: true,
      destinations: [],
      newDestinations: [],
      preferences: {},
      isConsentRequired: true
    }, _this.initialise = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {
      var _this$props, writeKey, otherWriteKeys, shouldRequireConsent, initialPreferences, mapCustomPreferences, _loadPreferences, destinationPreferences, customPreferences, _ref3, _ref4, isConsentRequired, destinations, newDestinations, preferences;

      return _regeneratorRuntime.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              _this$props = _this.props, writeKey = _this$props.writeKey, otherWriteKeys = _this$props.otherWriteKeys, shouldRequireConsent = _this$props.shouldRequireConsent, initialPreferences = _this$props.initialPreferences, mapCustomPreferences = _this$props.mapCustomPreferences;
              // TODO: add option to run mapCustomPreferences on load so that the destination preferences automatically get updated

              _loadPreferences = loadPreferences(), destinationPreferences = _loadPreferences.destinationPreferences, customPreferences = _loadPreferences.customPreferences;
              _context.next = 4;
              return _Promise.all([shouldRequireConsent(), fetchDestinations([writeKey].concat(_toConsumableArray(otherWriteKeys)))]);

            case 4:
              _ref3 = _context.sent;
              _ref4 = _slicedToArray(_ref3, 2);
              isConsentRequired = _ref4[0];
              destinations = _ref4[1];
              newDestinations = getNewDestinations(destinations, destinationPreferences);


              conditionallyLoadAnalytics({
                writeKey: writeKey,
                destinations: destinations,
                destinationPreferences: destinationPreferences,
                isConsentRequired: isConsentRequired
              });

              preferences = void 0;

              if (mapCustomPreferences) {
                preferences = customPreferences || initialPreferences;
              } else {
                preferences = destinationPreferences || initialPreferences;
              }

              _this.setState({
                isLoading: false,
                destinations: destinations,
                newDestinations: newDestinations,
                preferences: preferences,
                isConsentRequired: isConsentRequired
              });

            case 13:
            case 'end':
              return _context.stop();
          }
        }
      }, _callee, _this2);
    })), _this.handleSetPreferences = function (newPreferences) {
      _this.setState(function (prevState) {
        var destinations = prevState.destinations,
            existingPreferences = prevState.preferences;

        var preferences = _this.mergePreferences({
          destinations: destinations,
          newPreferences: newPreferences,
          existingPreferences: existingPreferences
        });
        return { preferences: preferences };
      });
    }, _this.handleResetPreferences = function () {
      var _this$props2 = _this.props,
          initialPreferences = _this$props2.initialPreferences,
          mapCustomPreferences = _this$props2.mapCustomPreferences;

      var _loadPreferences2 = loadPreferences(),
          destinationPreferences = _loadPreferences2.destinationPreferences,
          customPreferences = _loadPreferences2.customPreferences;

      var preferences = void 0;
      if (mapCustomPreferences) {
        preferences = customPreferences || initialPreferences;
      } else {
        preferences = destinationPreferences || initialPreferences;
      }

      _this.setState({ preferences: preferences });
    }, _this.handleSaveConsent = function (newPreferences, shouldReload) {
      var _this$props3 = _this.props,
          writeKey = _this$props3.writeKey,
          cookieDomain = _this$props3.cookieDomain,
          mapCustomPreferences = _this$props3.mapCustomPreferences;


      _this.setState(function (prevState) {
        var destinations = prevState.destinations,
            existingPreferences = prevState.preferences,
            isConsentRequired = prevState.isConsentRequired;


        var preferences = _this.mergePreferences({
          destinations: destinations,
          newPreferences: newPreferences,
          existingPreferences: existingPreferences
        });

        var destinationPreferences = void 0;
        var customPreferences = void 0;
        if (mapCustomPreferences) {
          ;
          var _mapCustomPreferences = mapCustomPreferences({
            destinations: destinations,
            preferences: preferences
          });

          destinationPreferences = _mapCustomPreferences.destinationPreferences;
          customPreferences = _mapCustomPreferences.customPreferences;

          if (customPreferences) {
            // Allow the customPreferences to be updated from mapCustomPreferences
            preferences = customPreferences;
          } else {
            // Make returning the customPreferences from mapCustomPreferences optional
            customPreferences = preferences;
          }
        } else {
          destinationPreferences = preferences;
        }

        var newDestinations = getNewDestinations(destinations, destinationPreferences);

        savePreferences({ destinationPreferences: destinationPreferences, customPreferences: customPreferences, cookieDomain: cookieDomain });
        conditionallyLoadAnalytics({
          writeKey: writeKey,
          destinations: destinations,
          destinationPreferences: destinationPreferences,
          isConsentRequired: isConsentRequired,
          shouldReload: shouldReload
        });

        return { destinationPreferences: destinationPreferences, preferences: preferences, newDestinations: newDestinations };
      });
    }, _this.mergePreferences = function (_ref5) {
      var destinations = _ref5.destinations,
          existingPreferences = _ref5.existingPreferences,
          newPreferences = _ref5.newPreferences;

      var preferences = void 0;

      if (typeof newPreferences === 'boolean') {
        var destinationPreferences = {};
        var _iteratorNormalCompletion2 = true;
        var _didIteratorError2 = false;
        var _iteratorError2 = undefined;

        try {
          for (var _iterator2 = _getIterator(destinations), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
            var destination = _step2.value;

            destinationPreferences[destination.id] = newPreferences;
          }
        } catch (err) {
          _didIteratorError2 = true;
          _iteratorError2 = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion2 && _iterator2.return) {
              _iterator2.return();
            }
          } finally {
            if (_didIteratorError2) {
              throw _iteratorError2;
            }
          }
        }

        preferences = destinationPreferences;
      } else if (newPreferences) {
        preferences = _extends({}, existingPreferences, newPreferences);
      } else {
        preferences = existingPreferences;
      }

      return preferences;
    }, _temp), _possibleConstructorReturn(_this, _ret);
  }

  _createClass(ConsentManagerBuilder, [{
    key: 'render',
    value: function render() {
      var children = this.props.children;
      var _state = this.state,
          isLoading = _state.isLoading,
          destinations = _state.destinations,
          preferences = _state.preferences,
          newDestinations = _state.newDestinations,
          isConsentRequired = _state.isConsentRequired;


      if (isLoading) {
        return null;
      }

      return children({
        destinations: destinations,
        newDestinations: newDestinations,
        preferences: preferences,
        isConsentRequired: isConsentRequired,
        setPreferences: this.handleSetPreferences,
        resetPreferences: this.handleResetPreferences,
        saveConsent: this.handleSaveConsent
      });
    }
  }, {
    key: 'componentDidMount',
    value: function () {
      var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {
        var onError;
        return _regeneratorRuntime.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                onError = this.props.onError;

                if (!(onError && typeof onError === 'function')) {
                  _context2.next = 13;
                  break;
                }

                _context2.prev = 2;
                _context2.next = 5;
                return this.initialise();

              case 5:
                _context2.next = 11;
                break;

              case 7:
                _context2.prev = 7;
                _context2.t0 = _context2['catch'](2);
                _context2.next = 11;
                return onError(_context2.t0);

              case 11:
                _context2.next = 14;
                break;

              case 13:
                this.initialise();

              case 14:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this, [[2, 7]]);
      }));

      function componentDidMount() {
        return _ref6.apply(this, arguments);
      }

      return componentDidMount;
    }()
  }]);

  return ConsentManagerBuilder;
}(Component);

ConsentManagerBuilder.displayName = 'ConsentManagerBuilder';
ConsentManagerBuilder.propTypes = {
  children: PropTypes.func.isRequired,
  onError: PropTypes.func,
  writeKey: PropTypes.string.isRequired,
  otherWriteKeys: PropTypes.arrayOf(PropTypes.string),
  shouldRequireConsent: PropTypes.func,
  initialPreferences: PropTypes.object,
  mapCustomPreferences: PropTypes.func,
  cookieDomain: PropTypes.string
};
ConsentManagerBuilder.defaultProps = {
  otherWriteKeys: [],
  onError: undefined,
  shouldRequireConsent: function shouldRequireConsent() {
    return true;
  },
  initialPreferences: {},
  mapCustomPreferences: undefined,
  cookieDomain: undefined
};
export default ConsentManagerBuilder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25zZW50LW1hbmFnZXItYnVpbGRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJDb21wb25lbnQiLCJQcm9wVHlwZXMiLCJsb2FkUHJlZmVyZW5jZXMiLCJzYXZlUHJlZmVyZW5jZXMiLCJmZXRjaERlc3RpbmF0aW9ucyIsImNvbmRpdGlvbmFsbHlMb2FkQW5hbHl0aWNzIiwiZ2V0TmV3RGVzdGluYXRpb25zIiwiZGVzdGluYXRpb25zIiwicHJlZmVyZW5jZXMiLCJuZXdEZXN0aW5hdGlvbnMiLCJkZXN0aW5hdGlvbiIsImlkIiwidW5kZWZpbmVkIiwicHVzaCIsIkNvbnNlbnRNYW5hZ2VyQnVpbGRlciIsInN0YXRlIiwiaXNMb2FkaW5nIiwiaXNDb25zZW50UmVxdWlyZWQiLCJpbml0aWFsaXNlIiwicHJvcHMiLCJ3cml0ZUtleSIsIm90aGVyV3JpdGVLZXlzIiwic2hvdWxkUmVxdWlyZUNvbnNlbnQiLCJpbml0aWFsUHJlZmVyZW5jZXMiLCJtYXBDdXN0b21QcmVmZXJlbmNlcyIsImRlc3RpbmF0aW9uUHJlZmVyZW5jZXMiLCJjdXN0b21QcmVmZXJlbmNlcyIsImFsbCIsInNldFN0YXRlIiwiaGFuZGxlU2V0UHJlZmVyZW5jZXMiLCJwcmV2U3RhdGUiLCJleGlzdGluZ1ByZWZlcmVuY2VzIiwibWVyZ2VQcmVmZXJlbmNlcyIsIm5ld1ByZWZlcmVuY2VzIiwiaGFuZGxlUmVzZXRQcmVmZXJlbmNlcyIsImhhbmRsZVNhdmVDb25zZW50Iiwic2hvdWxkUmVsb2FkIiwiY29va2llRG9tYWluIiwiY2hpbGRyZW4iLCJzZXRQcmVmZXJlbmNlcyIsInJlc2V0UHJlZmVyZW5jZXMiLCJzYXZlQ29uc2VudCIsIm9uRXJyb3IiLCJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsImZ1bmMiLCJpc1JlcXVpcmVkIiwic3RyaW5nIiwiYXJyYXlPZiIsIm9iamVjdCIsImRlZmF1bHRQcm9wcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsU0FBUUEs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SUFMZjtBQU1qQnRCLHNCQUFvQnRCLFVBQVVnRCxNQU5iO0FBT2pCekIsd0JBQXNCdkIsVUFBVTRDLElBUGY7QUFRakJSLGdCQUFjcEMsVUFBVThDO0FBUlAsQztBQUhBakMscUIsQ0FjWm9DLFksR0FBZTtBQUNwQjdCLGtCQUFnQixFQURJO0FBRXBCcUIsV0FBUzlCLFNBRlc7QUFHcEJVLHdCQUFzQjtBQUFBLFdBQU0sSUFBTjtBQUFBLEdBSEY7QUFJcEJDLHNCQUFvQixFQUpBO0FBS3BCQyx3QkFBc0JaLFNBTEY7QUFNcEJ5QixnQkFBY3pCO0FBTk0sQztlQWRIRSxxQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50fSBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCB7bG9hZFByZWZlcmVuY2VzLCBzYXZlUHJlZmVyZW5jZXN9IGZyb20gJy4vcHJlZmVyZW5jZXMnXG5pbXBvcnQgZmV0Y2hEZXN0aW5hdGlvbnMgZnJvbSAnLi9mZXRjaC1kZXN0aW5hdGlvbnMnXG5pbXBvcnQgY29uZGl0aW9uYWxseUxvYWRBbmFseXRpY3MgZnJvbSAnLi9hbmFseXRpY3MnXG5cbmZ1bmN0aW9uIGdldE5ld0Rlc3RpbmF0aW9ucyhkZXN0aW5hdGlvbnMsIHByZWZlcmVuY2VzKSB7XG4gIGNvbnN0IG5ld0Rlc3RpbmF0aW9ucyA9IFtdXG5cbiAgLy8gSWYgdGhlcmUgYXJlIG5vIHByZWZlcmVuY2VzIHRoZW4gYWxsIGRlc3RpbmF0aW9ucyBhcmUgbmV3XG4gIGlmICghcHJlZmVyZW5jZXMpIHtcbiAgICByZXR1cm4gZGVzdGluYXRpb25zXG4gIH1cblxuICBmb3IgKGNvbnN0IGRlc3RpbmF0aW9uIG9mIGRlc3RpbmF0aW9ucykge1xuICAgIGlmIChwcmVmZXJlbmNlc1tkZXN0aW5hdGlvbi5pZF0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgbmV3RGVzdGluYXRpb25zLnB1c2goZGVzdGluYXRpb24pXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5ld0Rlc3RpbmF0aW9uc1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb25zZW50TWFuYWdlckJ1aWxkZXIgZXh0ZW5kcyBDb21wb25lbnQge1xuICBzdGF0aWMgZGlzcGxheU5hbWUgPSAnQ29uc2VudE1hbmFnZXJCdWlsZGVyJ1xuXG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgY2hpbGRyZW46IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gICAgb25FcnJvcjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgd3JpdGVLZXk6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICBvdGhlcldyaXRlS2V5czogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLnN0cmluZyksXG4gICAgc2hvdWxkUmVxdWlyZUNvbnNlbnQ6IFByb3BUeXBlcy5mdW5jLFxuICAgIGluaXRpYWxQcmVmZXJlbmNlczogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBtYXBDdXN0b21QcmVmZXJlbmNlczogUHJvcFR5cGVzLmZ1bmMsXG4gICAgY29va2llRG9tYWluOiBQcm9wVHlwZXMuc3RyaW5nXG4gIH1cblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIG90aGVyV3JpdGVLZXlzOiBbXSxcbiAgICBvbkVycm9yOiB1bmRlZmluZWQsXG4gICAgc2hvdWxkUmVxdWlyZUNvbnNlbnQ6ICgpID0+IHRydWUsXG4gICAgaW5pdGlhbFByZWZlcmVuY2VzOiB7fSxcbiAgICBtYXBDdXN0b21QcmVmZXJlbmNlczogdW5kZWZpbmVkLFxuICAgIGNvb2tpZURvbWFpbjogdW5kZWZpbmVkXG4gIH1cblxuICBzdGF0ZSA9IHtcbiAgICBpc0xvYWRpbmc6IHRydWUsXG4gICAgZGVzdGluYXRpb25zOiBbXSxcbiAgICBuZXdEZXN0aW5hdGlvbnM6IFtdLFxuICAgIHByZWZlcmVuY2VzOiB7fSxcbiAgICBpc0NvbnNlbnRSZXF1aXJlZDogdHJ1ZVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtjaGlsZHJlbn0gPSB0aGlzLnByb3BzXG4gICAgY29uc3Qge1xuICAgICAgaXNMb2FkaW5nLFxuICAgICAgZGVzdGluYXRpb25zLFxuICAgICAgcHJlZmVyZW5jZXMsXG4gICAgICBuZXdEZXN0aW5hdGlvbnMsXG4gICAgICBpc0NvbnNlbnRSZXF1aXJlZFxuICAgIH0gPSB0aGlzLnN0YXRlXG5cbiAgICBpZiAoaXNMb2FkaW5nKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cblxuICAgIHJldHVybiBjaGlsZHJlbih7XG4gICAgICBkZXN0aW5hdGlvbnMsXG4gICAgICBuZXdEZXN0aW5hdGlvbnMsXG4gICAgICBwcmVmZXJlbmNlcyxcbiAgICAgIGlzQ29uc2VudFJlcXVpcmVkLFxuICAgICAgc2V0UHJlZmVyZW5jZXM6IHRoaXMuaGFuZGxlU2V0UHJlZmVyZW5jZXMsXG4gICAgICByZXNldFByZWZlcmVuY2VzOiB0aGlzLmhhbmRsZVJlc2V0UHJlZmVyZW5jZXMsXG4gICAgICBzYXZlQ29uc2VudDogdGhpcy5oYW5kbGVTYXZlQ29uc2VudFxuICAgIH0pXG4gIH1cblxuICBhc3luYyBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICBjb25zdCB7b25FcnJvcn0gPSB0aGlzLnByb3BzXG4gICAgaWYgKG9uRXJyb3IgJiYgdHlwZW9mIG9uRXJyb3IgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuaW5pdGlhbGlzZSgpXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGF3YWl0IG9uRXJyb3IoZSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5pbml0aWFsaXNlKClcbiAgICB9XG4gIH1cblxuICBpbml0aWFsaXNlID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIHdyaXRlS2V5LFxuICAgICAgb3RoZXJXcml0ZUtleXMsXG4gICAgICBzaG91bGRSZXF1aXJlQ29uc2VudCxcbiAgICAgIGluaXRpYWxQcmVmZXJlbmNlcyxcbiAgICAgIG1hcEN1c3RvbVByZWZlcmVuY2VzXG4gICAgfSA9IHRoaXMucHJvcHNcbiAgICAvLyBUT0RPOiBhZGQgb3B0aW9uIHRvIHJ1biBtYXBDdXN0b21QcmVmZXJlbmNlcyBvbiBsb2FkIHNvIHRoYXQgdGhlIGRlc3RpbmF0aW9uIHByZWZlcmVuY2VzIGF1dG9tYXRpY2FsbHkgZ2V0IHVwZGF0ZWRcbiAgICBjb25zdCB7ZGVzdGluYXRpb25QcmVmZXJlbmNlcywgY3VzdG9tUHJlZmVyZW5jZXN9ID0gbG9hZFByZWZlcmVuY2VzKClcblxuICAgIGNvbnN0IFtpc0NvbnNlbnRSZXF1aXJlZCwgZGVzdGluYXRpb25zXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHNob3VsZFJlcXVpcmVDb25zZW50KCksXG4gICAgICBmZXRjaERlc3RpbmF0aW9ucyhbd3JpdGVLZXksIC4uLm90aGVyV3JpdGVLZXlzXSlcbiAgICBdKVxuXG4gICAgY29uc3QgbmV3RGVzdGluYXRpb25zID0gZ2V0TmV3RGVzdGluYXRpb25zKFxuICAgICAgZGVzdGluYXRpb25zLFxuICAgICAgZGVzdGluYXRpb25QcmVmZXJlbmNlc1xuICAgIClcblxuICAgIGNvbmRpdGlvbmFsbHlMb2FkQW5hbHl0aWNzKHtcbiAgICAgIHdyaXRlS2V5LFxuICAgICAgZGVzdGluYXRpb25zLFxuICAgICAgZGVzdGluYXRpb25QcmVmZXJlbmNlcyxcbiAgICAgIGlzQ29uc2VudFJlcXVpcmVkXG4gICAgfSlcblxuICAgIGxldCBwcmVmZXJlbmNlc1xuICAgIGlmIChtYXBDdXN0b21QcmVmZXJlbmNlcykge1xuICAgICAgcHJlZmVyZW5jZXMgPSBjdXN0b21QcmVmZXJlbmNlcyB8fCBpbml0aWFsUHJlZmVyZW5jZXNcbiAgICB9IGVsc2Uge1xuICAgICAgcHJlZmVyZW5jZXMgPSBkZXN0aW5hdGlvblByZWZlcmVuY2VzIHx8IGluaXRpYWxQcmVmZXJlbmNlc1xuICAgIH1cblxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICAgIGRlc3RpbmF0aW9ucyxcbiAgICAgIG5ld0Rlc3RpbmF0aW9ucyxcbiAgICAgIHByZWZlcmVuY2VzLFxuICAgICAgaXNDb25zZW50UmVxdWlyZWRcbiAgICB9KVxuICB9XG5cbiAgaGFuZGxlU2V0UHJlZmVyZW5jZXMgPSBuZXdQcmVmZXJlbmNlcyA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZShwcmV2U3RhdGUgPT4ge1xuICAgICAgY29uc3Qge2Rlc3RpbmF0aW9ucywgcHJlZmVyZW5jZXM6IGV4aXN0aW5nUHJlZmVyZW5jZXN9ID0gcHJldlN0YXRlXG4gICAgICBjb25zdCBwcmVmZXJlbmNlcyA9IHRoaXMubWVyZ2VQcmVmZXJlbmNlcyh7XG4gICAgICAgIGRlc3RpbmF0aW9ucyxcbiAgICAgICAgbmV3UHJlZmVyZW5jZXMsXG4gICAgICAgIGV4aXN0aW5nUHJlZmVyZW5jZXNcbiAgICAgIH0pXG4gICAgICByZXR1cm4ge3ByZWZlcmVuY2VzfVxuICAgIH0pXG4gIH1cblxuICBoYW5kbGVSZXNldFByZWZlcmVuY2VzID0gKCkgPT4ge1xuICAgIGNvbnN0IHtpbml0aWFsUHJlZmVyZW5jZXMsIG1hcEN1c3RvbVByZWZlcmVuY2VzfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCB7ZGVzdGluYXRpb25QcmVmZXJlbmNlcywgY3VzdG9tUHJlZmVyZW5jZXN9ID0gbG9hZFByZWZlcmVuY2VzKClcblxuICAgIGxldCBwcmVmZXJlbmNlc1xuICAgIGlmIChtYXBDdXN0b21QcmVmZXJlbmNlcykge1xuICAgICAgcHJlZmVyZW5jZXMgPSBjdXN0b21QcmVmZXJlbmNlcyB8fCBpbml0aWFsUHJlZmVyZW5jZXNcbiAgICB9IGVsc2Uge1xuICAgICAgcHJlZmVyZW5jZXMgPSBkZXN0aW5hdGlvblByZWZlcmVuY2VzIHx8IGluaXRpYWxQcmVmZXJlbmNlc1xuICAgIH1cblxuICAgIHRoaXMuc2V0U3RhdGUoe3ByZWZlcmVuY2VzfSlcbiAgfVxuXG4gIGhhbmRsZVNhdmVDb25zZW50ID0gKG5ld1ByZWZlcmVuY2VzLCBzaG91bGRSZWxvYWQpID0+IHtcbiAgICBjb25zdCB7d3JpdGVLZXksIGNvb2tpZURvbWFpbiwgbWFwQ3VzdG9tUHJlZmVyZW5jZXN9ID0gdGhpcy5wcm9wc1xuXG4gICAgdGhpcy5zZXRTdGF0ZShwcmV2U3RhdGUgPT4ge1xuICAgICAgY29uc3Qge1xuICAgICAgICBkZXN0aW5hdGlvbnMsXG4gICAgICAgIHByZWZlcmVuY2VzOiBleGlzdGluZ1ByZWZlcmVuY2VzLFxuICAgICAgICBpc0NvbnNlbnRSZXF1aXJlZFxuICAgICAgfSA9IHByZXZTdGF0ZVxuXG4gICAgICBsZXQgcHJlZmVyZW5jZXMgPSB0aGlzLm1lcmdlUHJlZmVyZW5jZXMoe1xuICAgICAgICBkZXN0aW5hdGlvbnMsXG4gICAgICAgIG5ld1ByZWZlcmVuY2VzLFxuICAgICAgICBleGlzdGluZ1ByZWZlcmVuY2VzXG4gICAgICB9KVxuXG4gICAgICBsZXQgZGVzdGluYXRpb25QcmVmZXJlbmNlc1xuICAgICAgbGV0IGN1c3RvbVByZWZlcmVuY2VzXG4gICAgICBpZiAobWFwQ3VzdG9tUHJlZmVyZW5jZXMpIHtcbiAgICAgICAgOyh7ZGVzdGluYXRpb25QcmVmZXJlbmNlcywgY3VzdG9tUHJlZmVyZW5jZXN9ID0gbWFwQ3VzdG9tUHJlZmVyZW5jZXMoe1xuICAgICAgICAgIGRlc3RpbmF0aW9ucyxcbiAgICAgICAgICBwcmVmZXJlbmNlc1xuICAgICAgICB9KSlcbiAgICAgICAgaWYgKGN1c3RvbVByZWZlcmVuY2VzKSB7XG4gICAgICAgICAgLy8gQWxsb3cgdGhlIGN1c3RvbVByZWZlcmVuY2VzIHRvIGJlIHVwZGF0ZWQgZnJvbSBtYXBDdXN0b21QcmVmZXJlbmNlc1xuICAgICAgICAgIHByZWZlcmVuY2VzID0gY3VzdG9tUHJlZmVyZW5jZXNcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBNYWtlIHJldHVybmluZyB0aGUgY3VzdG9tUHJlZmVyZW5jZXMgZnJvbSBtYXBDdXN0b21QcmVmZXJlbmNlcyBvcHRpb25hbFxuICAgICAgICAgIGN1c3RvbVByZWZlcmVuY2VzID0gcHJlZmVyZW5jZXNcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVzdGluYXRpb25QcmVmZXJlbmNlcyA9IHByZWZlcmVuY2VzXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG5ld0Rlc3RpbmF0aW9ucyA9IGdldE5ld0Rlc3RpbmF0aW9ucyhcbiAgICAgICAgZGVzdGluYXRpb25zLFxuICAgICAgICBkZXN0aW5hdGlvblByZWZlcmVuY2VzXG4gICAgICApXG5cbiAgICAgIHNhdmVQcmVmZXJlbmNlcyh7ZGVzdGluYXRpb25QcmVmZXJlbmNlcywgY3VzdG9tUHJlZmVyZW5jZXMsIGNvb2tpZURvbWFpbn0pXG4gICAgICBjb25kaXRpb25hbGx5TG9hZEFuYWx5dGljcyh7XG4gICAgICAgIHdyaXRlS2V5LFxuICAgICAgICBkZXN0aW5hdGlvbnMsXG4gICAgICAgIGRlc3RpbmF0aW9uUHJlZmVyZW5jZXMsXG4gICAgICAgIGlzQ29uc2VudFJlcXVpcmVkLFxuICAgICAgICBzaG91bGRSZWxvYWRcbiAgICAgIH0pXG5cbiAgICAgIHJldHVybiB7ZGVzdGluYXRpb25QcmVmZXJlbmNlcywgcHJlZmVyZW5jZXMsIG5ld0Rlc3RpbmF0aW9uc31cbiAgICB9KVxuICB9XG5cbiAgbWVyZ2VQcmVmZXJlbmNlcyA9ICh7ZGVzdGluYXRpb25zLCBleGlzdGluZ1ByZWZlcmVuY2VzLCBuZXdQcmVmZXJlbmNlc30pID0+IHtcbiAgICBsZXQgcHJlZmVyZW5jZXNcblxuICAgIGlmICh0eXBlb2YgbmV3UHJlZmVyZW5jZXMgPT09ICdib29sZWFuJykge1xuICAgICAgY29uc3QgZGVzdGluYXRpb25QcmVmZXJlbmNlcyA9IHt9XG4gICAgICBmb3IgKGNvbnN0IGRlc3RpbmF0aW9uIG9mIGRlc3RpbmF0aW9ucykge1xuICAgICAgICBkZXN0aW5hdGlvblByZWZlcmVuY2VzW2Rlc3RpbmF0aW9uLmlkXSA9IG5ld1ByZWZlcmVuY2VzXG4gICAgICB9XG4gICAgICBwcmVmZXJlbmNlcyA9IGRlc3RpbmF0aW9uUHJlZmVyZW5jZXNcbiAgICB9IGVsc2UgaWYgKG5ld1ByZWZlcmVuY2VzKSB7XG4gICAgICBwcmVmZXJlbmNlcyA9IHtcbiAgICAgICAgLi4uZXhpc3RpbmdQcmVmZXJlbmNlcyxcbiAgICAgICAgLi4ubmV3UHJlZmVyZW5jZXNcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcHJlZmVyZW5jZXMgPSBleGlzdGluZ1ByZWZlcmVuY2VzXG4gICAgfVxuXG4gICAgcmV0dXJuIHByZWZlcmVuY2VzXG4gIH1cbn1cbiJdfQ==